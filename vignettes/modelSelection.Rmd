---
title: "modelSelection"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{modelSelection}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(parafac4microbiome)
library(dplyr)
library(ggplot2)
library(ggpubr)
```

```{r Fujita num comp selection}
# Setup
minNumComponents = 1
maxNumComponents = 3
numRepetitions = 5 # number of randomly initialized models
numFolds = 8 # number of jack-knifed models
ctol = 1e-6
maxit = 200
numCores= 1

colourCols = c("", "Genus", "")
legendTitles = c("", "Genus", "")
xLabels = c("Replicate", "Feature index", "Time point")
legendColNums = c(0,5,0)
arrangeModes = c(FALSE, TRUE, FALSE)
continuousModes = c(FALSE,FALSE,TRUE)

# Preprocess
processedFujita = processDataCube(Fujita2023, sparsityThreshold=0.99, centerMode=1, scaleMode=2)

# Assess the metrics to determine the correct number of components
assessment = assessNumComponents(processedFujita$data, minNumComponents, maxNumComponents, numRepetitions, ctol=ctol, maxit=maxit, numCores=numCores)
assessment$plots$overview

# Model stability check using jack-knifing
for(f in minNumComponents:maxNumComponents){
  stabilityCheck = modelStabilityCheck(processedFujita, numComponents=f, numFolds=numFolds, considerGroups=FALSE,
                               groupVariable="", colourCols, legendTitles, xLabels, legendColNums, arrangeModes,
                               continuousModes, ctol=ctol, maxit=maxit, numCores=numCores)
  print(stabilityCheck$plot)
}

# CORCONDIA is still well above 60 and the model is moderately stable at 3 components.
# Here we decide on selecting the best 3-component model, i.e. explaining the largest amount of variation.
# Alternative: select based on maximum CORCONDIA.
numComponents = 3
modelChoice = which(assessment$metrics$varExp[,numComponents] == max(assessment$metrics$varExp[,numComponents]))
finalModel = assessment$models[[numComponents]][[modelChoice]]

plotPARAFACmodel(finalModel, processedFujita, colourCols, legendTitles, xLabels, legendColNums, arrangeModes,
  continuousModes = c(FALSE,FALSE,TRUE),
  overallTitle = "Fujita PARAFAC model")

# Due to the random initializations, this model may be slightly different from the paper.
```

```{r Shao comp selection}
# Setup
# For computational purposes we deviate from the default settings
minNumComponents = 1
maxNumComponents = 3
numRepetitions = 5 # number of randomly initialized models
numFolds = 5 # number of jack-knifed models
maxit = 200
ctol= 1e-4 # this is a really bad setting but is needed to save computational time
numCores = 1

colourCols = c("Delivery_mode", "phylum", "")
legendTitles = c("Delivery mode", "Phylum", "")
xLabels = c("Subject index", "Feature index", "Time index")
legendColNums = c(3,5,0)
arrangeModes = c(TRUE, TRUE, FALSE)
continuousModes = c(FALSE,FALSE,TRUE)

# Pre-process the data
processedShao = processDataCube(Shao2019, sparsityThreshold=0.9, considerGroups=TRUE, groupVariable="Delivery_mode", centerMode=1, scaleMode=2)

# Assess the metrics to determine the correct number of components
assessment = assessNumComponents(processedShao$data, minNumComponents, maxNumComponents, numRepetitions, ctol=ctol, maxit=maxit, numCores=numCores)
assessment$plots$overview

# Model stability check using jack-knifing
for(f in minNumComponents:maxNumComponents){
  stabilityCheck = modelStabilityCheck(processedShao, numComponents=f, numFolds=numFolds, considerGroups=TRUE,
                               groupVariable="Delivery_mode", colourCols, legendTitles, xLabels, legendColNums, arrangeModes,
                               continuousModes, ctol=ctol, maxit=maxit, numCores=numCores)
  print(stabilityCheck$plot)
}

# Here we decide on selecting the best 2-component model, i.e. explaining the largest amount of variation.
# Alternative: select based on maximum CORCONDIA.
numComponents = 2
modelChoice = which(assessment$metrics$varExp[,numComponents] == max(assessment$metrics$varExp[,numComponents]))
finalModel = assessment$models[[numComponents]][[modelChoice]]

plotPARAFACmodel(finalModel, processedShao,
  colourCols,
  legendTitles,
  xLabels,
  legendColNums,
  arrangeModes,
  continuousModes,
  overallTitle = "Shao2019 PARAFAC model")
```

```{r vanderPloeg comp selection}
# Setup
# For computational purposes we deviate from the default settings
minNumComponents = 1
maxNumComponents = 3
numRepetitions = 5 # number of randomly initialized models
numFolds = 5 # number of jack-knifed models
ctol = 1e-6
maxit = 250
numCores = 1

colourCols = c("RFgroup", "Phylum", "")
legendTitles = c("RF group", "Phylum", "")
xLabels = c("Subject index", "Feature index", "Time index")
legendColNums = c(2,5,0)
arrangeModes = c(TRUE, TRUE, FALSE)
continuousModes = c(FALSE,FALSE,TRUE)

# Preprocess the data
processedPloeg = processDataCube(vanderPloeg2024, sparsityThreshold=0.50, considerGroups=TRUE, groupVariable="RFgroup", centerMode=1, scaleMode=2)

# Assess the metrics to determine the correct number of components
assessment = assessNumComponents(processedPloeg$data, minNumComponents, maxNumComponents, numRepetitions, ctol=ctol, maxit=maxit, numCores=numCores)
assessment$plots$overview

# Model stability check using jack-knifing
for(f in minNumComponents:maxNumComponents){
  stabilityCheck = modelStabilityCheck(processedPloeg, numComponents=f, numFolds=numFolds, considerGroups=TRUE,
                               groupVariable="RFgroup", colourCols, legendTitles, xLabels, legendColNums, arrangeModes,
                               continuousModes, ctol=ctol, maxit=maxit, numCores=numCores)
  print(stabilityCheck$plot)
}

# Here we decide on selecting the best 2-component model, i.e. explaining the largest amount of variation.
# Alternative: select based on maximum CORCONDIA.
numComponents = 2
modelChoice = which(assessment$metrics$varExp[,numComponents] == max(assessment$metrics$varExp[,numComponents]))
finalModel = assessment$models[[numComponents]][[modelChoice]]

plotPARAFACmodel(finalModel, processedPloeg,
  colourCols,
  legendTitles,
  xLabels,
  legendColNums,
  arrangeModes,
  continuousModes,
  overallTitle = "vanderPloeg2024 PARAFAC model")
```
