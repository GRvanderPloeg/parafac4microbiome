---
title: "AP"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(dplyr)
library(parafac4microbiome)
library(NPLStoolbox)
library(CMTFtoolbox)
```

# PCA
```{r pca processing}
processedMicrobiome = CMTFtoolbox::Georgiou2025$Tooth_microbiome

# Remove samples due to low library size
mask = rowSums(processedMicrobiome$data) > 6500
processedMicrobiome$data = processedMicrobiome$data[mask,]
processedMicrobiome$mode1 = processedMicrobiome$mode1[mask,]

# CLR transformation
df = processedMicrobiome$data + 1
geomeans = pracma::geomean(as.matrix(df), dim=2)
df_clr = log(sweep(df, 1, geomeans, FUN="/"))

# Feature filtering
sparsityThreshold = 0.5
maskA = processedMicrobiome$mode1$PainS_NopainA == "A"
maskS = processedMicrobiome$mode1$PainS_NopainA == "S"

dfA = processedMicrobiome$data[maskA,]
dfS = processedMicrobiome$data[maskS,]

sparsityA = colSums(dfA == 0) / nrow(dfA)
sparsityS = colSums(dfS == 0) / nrow(dfS)

mask = (sparsityA <= sparsityThreshold) | (sparsityS <= sparsityThreshold)

processedMicrobiome$data = df_clr[,mask]
processedMicrobiome$mode2 = processedMicrobiome$mode2[mask,]

# Center and scale
processedMicrobiome$data = sweep(processedMicrobiome$data, 2, colMeans(processedMicrobiome$data), FUN="-")
processedMicrobiome$data = sweep(processedMicrobiome$data, 2, apply(processedMicrobiome$data, 2, sd), FUN="/")
```

```{r model selection}
if(!require(psych))   install.packages("psych")
if(!require(factoextra)) install.packages("factoextra")

library(psych)       # for fa.parallel()
library(factoextra)  # for fviz_eig()

# 2. Run PCA
pca_res <- prcomp(processedMicrobiome$data, center = FALSE, scale. = FALSE)

# 3. Compute variance explained
eigenvalues <- pca_res$sdev^2
var_explained <- eigenvalues / sum(eigenvalues) * 100

# 4. Build a data frame for plotting
scree_df <- data.frame(
  PC       = factor(seq_along(var_explained)),
  Variance = var_explained
)

# 5. Plot with ggplot2
ggplot(scree_df, aes(x = PC, y = Variance, group = 1)) +
  geom_line() +
  geom_point(size = 2) +
  labs(
    x     = "Number of components",
    y     = "Variance explained (%)"
  ) +
  theme(text=element_text(size=16))
```

```{r pca}
svd_result = svd(processedMicrobiome$data, nu=3, nv=3)

scores = svd_result$u %*% diag(svd_result$d[1:3])
loadings = svd_result$v

Xhat = scores[,1:3] %*% t(loadings[,1:3])
varExp = round(sum(Xhat^2) / sum(processedMicrobiome$data^2) * 100, 2)

Xhat1 = scores[,1] %*% t(loadings[,1])
Xhat2 = scores[,2] %*% t(loadings[,2])
varExp1 = round(sum(Xhat1^2) / sum(processedMicrobiome$data^2) * 100, 2)
varExp2 = round(sum(Xhat2^2) / sum(processedMicrobiome$data^2) * 100, 2)

```

```{r pca test metadata}
df = processedMicrobiome$mode1 %>% mutate(V1=scores[,1],V2=scores[,2],V3=scores[,3]) %>% mutate(Gender = as.numeric(as.factor(Gender)), PainS_NopainA = as.numeric(as.factor(PainS_NopainA)))

summary(lm(V1 ~ Gender + PainS_NopainA, data=df))
summary(lm(V2 ~ Gender + PainS_NopainA, data=df))
summary(lm(V3 ~ Gender + PainS_NopainA, data=df))
```
# CP

```{r cp processing}
# Full cohort
processedCytokines_full = CMTFtoolbox::Georgiou2025$Inflammatory_mediators
processedCytokines_full$data = log(processedCytokines_full$data + 0.005)

# Remove outlier subjects: A11-8
processedCytokines_full$data = processedCytokines_full$data[-25,,]
processedCytokines_full$mode1 = processedCytokines_full$mode1[-25,]

processedCytokines_full$data = multiwayCenter(processedCytokines_full$data, 1)
processedCytokines_full$data = multiwayScale(processedCytokines_full$data, 2)

# Control only subcohort
processedCytokines_control = CMTFtoolbox::Georgiou2025$Inflammatory_mediators

mask = processedCytokines_control$mode1$case_control == "control"
processedCytokines_control$data = processedCytokines_control$data[mask,,]
processedCytokines_control$mode1 = processedCytokines_control$mode1[mask,]

processedCytokines_control$data = log(processedCytokines_control$data + 0.005)
processedCytokines_control$data = multiwayCenter(processedCytokines_control$data, 1)
processedCytokines_control$data = multiwayScale(processedCytokines_control$data, 2)

# Case only subcohort
processedCytokines_case = CMTFtoolbox::Georgiou2025$Inflammatory_mediators

mask = processedCytokines_case$mode1$case_control == "case"
processedCytokines_case$data = processedCytokines_case$data[mask,,]
processedCytokines_case$mode1 = processedCytokines_case$mode1[mask,]

# Also remove subject A11-8 due to being an outlier
processedCytokines_case$data = processedCytokines_case$data[-25,,]
processedCytokines_case$mode1 = processedCytokines_case$mode1[-25,]

processedCytokines_case$data = log(processedCytokines_case$data + 0.005)
processedCytokines_case$data = multiwayCenter(processedCytokines_case$data, 1)
processedCytokines_case$data = multiwayScale(processedCytokines_case$data, 2)
```

```{r cp assess num components}
assessment_cytokines_full = parafac4microbiome::assessModelQuality(processedCytokines_full$data, numRepetitions=10, numCores=10)
assessment_cytokines_full$plots$overview # def 2

assessment_cytokines_control = parafac4microbiome::assessModelQuality(processedCytokines_control$data, numRepetitions=10, numCores=10)
assessment_cytokines_control$plots$overview # def 1

assessment_cytokines_case = parafac4microbiome::assessModelQuality(processedCytokines_case$data, numRepetitions=10, numCores=10)
assessment_cytokines_case$plots$overview # 2-4

assessment_cytokines_full$plots$overview
assessment_cytokines_control$plots$overview
assessment_cytokines_case$plots$overview
```

```{r cp stability num components}
colourCols = c("", "", "")
legendTitles = c("", "", "")
xLabels = c("Subject index", "Feature index", "Time index")
legendColNums = c(2,5,0)
arrangeModes = c(FALSE, FALSE, FALSE)
continuousModes = c(FALSE,FALSE,TRUE)

stability_cytokines = parafac4microbiome::assessModelStability(processedCytokines_case, maxNumComponents=4, numFolds=3, colourCols=colourCols, legendTitles=legendTitles, xLabels = xLabels, legendColNums=legendColNums, arrangeModes=arrangeModes, numCores=parallel::detectCores())
stability_cytokines$modelPlots[[2]]
stability_cytokines$modelPlots[[3]]
stability_cytokines$modelPlots[[4]]
```

```{r make cp models}
cp_cytokines_full = parafac4microbiome::parafac(processedCytokines_full$data, nfac=2, nstart=100)
cp_cytokines_control = parafac4microbiome::parafac(processedCytokines_control$data, nfac=1, nstart=100)
cp_cytokines_case = parafac4microbiome::parafac(processedCytokines_case$data, nfac=3, nstart=100)
```

```{r cp subject metadata test}
# Full
df = processedCytokines_full$mode1 %>% mutate(V1=cp_cytokines_full$Fac[[1]][,1],V2=cp_cytokines_full$Fac[[1]][,2]) %>% mutate(Gender = as.numeric(as.factor(Gender)), case_control = as.numeric(as.factor(case_control)), PainS_NopainA = as.numeric(as.factor(PainS_NopainA)))

summary(lm(V1 ~ Gender + case_control, data=df))
summary(lm(V2 ~ Gender + case_control, data=df))

# Control
df = processedCytokines_control$mode1 %>% mutate(V1=cp_cytokines_control$Fac[[1]][,1]) %>% mutate(Gender = as.numeric(as.factor(Gender)))
summary(lm(V1 ~ Gender, data=df))

# Case
df = processedCytokines_case$mode1 %>% mutate(V1=cp_cytokines_case$Fac[[1]][,1],V2=cp_cytokines_case$Fac[[1]][,2],V3=cp_cytokines_case$Fac[[1]][,3]) %>% mutate(Gender = as.numeric(as.factor(Gender)), PainS_NopainA = as.numeric(as.factor(PainS_NopainA)))
summary(lm(V1 ~ Gender + PainS_NopainA, data=df))
summary(lm(V2 ~ Gender + PainS_NopainA, data=df))
summary(lm(V3 ~ Gender + PainS_NopainA, data=df))
```

```{r plot models}
colourCols = c("", "", "")
legendTitles = c("", "", "")
xLabels = c("Subject index", "Feature index", "Time index")
legendColNums = c(2,5,0)
arrangeModes = c(FALSE, FALSE, FALSE)
continuousModes = c(FALSE,FALSE,TRUE)

parafac4microbiome::plotPARAFACmodel(cp_cytokines_full$Fac, processedCytokines_full, 2, colourCols, legendTitles, xLabels, legendColNums, arrangeModes, continuousModes,
  overallTitle = "Full cohort")
parafac4microbiome::plotPARAFACmodel(cp_cytokines_control$Fac, processedCytokines_control, 1, colourCols, legendTitles, xLabels, legendColNums, arrangeModes, continuousModes,
  overallTitle = "Control subcohort")
parafac4microbiome::plotPARAFACmodel(cp_cytokines_case$Fac, processedCytokines_case, 3, colourCols, legendTitles, xLabels, legendColNums, arrangeModes, continuousModes, overallTitle = "Case subcohort")
```

