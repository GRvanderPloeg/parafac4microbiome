---
title: "MAINHEALTH"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(ggpattern)
library(ggrepel)
library(stringr)
library(parafac4microbiome)
library(NPLStoolbox)
library(CMTFtoolbox)
library(scales)
library(vegan)
```

```{r define colours}
colours = RColorBrewer:: brewer.pal(8, "Dark2")
BMI_cols = c("darkgreen","darkgoldenrod","darkred") #colours[1:3]
WHZ_cols = c("darkgreen", "darkgoldenrod", "dodgerblue4")
phylum_cols = colours
```

# Processing
```{r process data}
processedFaeces = parafac4microbiome::processDataCube(NPLStoolbox::Jakobsen2025$faeces, sparsityThreshold = 0.75, centerMode=1, scaleMode=2)
processedMilk = parafac4microbiome::processDataCube(NPLStoolbox::Jakobsen2025$milkMicrobiome, sparsityThreshold=0.85, centerMode=1, scaleMode=2)
processedMilkMetab = parafac4microbiome::processDataCube(NPLStoolbox::Jakobsen2025$milkMetabolomics, CLR=FALSE, centerMode=1, scaleMode=2)
```

# CP
```{r CP assess num components}
assessment_faeces = parafac4microbiome::assessModelQuality(processedFaeces$data, numRepetitions = 5, numCores = 10)
assessment_milk = parafac4microbiome::assessModelQuality(processedMilk$data, numRepetitions = 10, numCores = 10)
assessment_milkMetab = parafac4microbiome::assessModelQuality(processedMilkMetab$data, numRepetitions = 10, numCores = 10)

assessment_faeces$plots$overview # 2 components
assessment_milk$plots$overview # 2 or 3 components, likely 3
assessment_milkMetab$plots$overview # 2 or 3 components, likely 3
```

```{r CP stability num components}
colourCols = c("BMI.group", "V3", "")
legendTitles = c("BMI group", "Phylum", "")
xLabels = c("Subject index", "Feature index", "Time index")
legendColNums = c(3,5,0)
arrangeModes = c(TRUE, TRUE, FALSE)
continuousModes = c(FALSE,FALSE,TRUE)

stability_milk = parafac4microbiome::assessModelStability(processedMilk, maxNumComponents=3, numFolds=10, colourCols=colourCols, legendTitles=legendTitles, xLabels = xLabels, legendColNums=legendColNums, arrangeModes=arrangeModes, numCores=parallel::detectCores())

stability_milkMetab = parafac4microbiome::assessModelStability(processedMilkMetab, maxNumComponents=3, numFolds=10, colourCols=c("BMI.group", "Class", ""), legendTitles=c("BMI group", "Class", ""), xLabels = xLabels, legendColNums=legendColNums, arrangeModes=arrangeModes, numCores=parallel::detectCores())

stability_milk$modelPlots[[2]] # 2 components ok
stability_milkMetab$modelPlots[[3]] # 3 components ok
```

```{r make cp models}
cp_faeces = parafac4microbiome::parafac(processedFaeces$data, nfac=2, nstart = 100)
cp_milk = parafac4microbiome::parafac(processedMilk$data, nfac=2, nstart = 100)
cp_milkMetab = parafac4microbiome::parafac(processedMilkMetab$data, nfac=3, nstart = 100)
```

```{r cp subject mode metadata test}
testMetadata = function(model, comp, metadata){
  transformedSubjectLoadings = transformPARAFACloadings(model$Fac, 1)[,comp]
  transformedSubjectLoadings = transformedSubjectLoadings / norm(transformedSubjectLoadings, "2")
  
  result = lm(transformedSubjectLoadings ~ BMI + C.section + Secretor + Lewis + whz.6m, data=metadata$mode1)
  
  # Extract coefficients and confidence intervals
  coef_estimates <- summary(result)$coefficients
  conf_intervals <- confint(result)
  
  # Remove intercept
  coef_estimates <- coef_estimates[rownames(coef_estimates) != "(Intercept)", ]
  conf_intervals <- conf_intervals[rownames(conf_intervals) != "(Intercept)", ]
  
  # Combine into a clean data frame
  summary_table <- data.frame(
    Term     = rownames(coef_estimates),
    Estimate = coef_estimates[, "Estimate"] * 1e3,
    CI       = paste0(
                 conf_intervals[, 1], " â€“ ",
                 conf_intervals[, 2]
               ),
    P_value  = coef_estimates[, "Pr(>|t|)"],
    P_adjust = p.adjust(coef_estimates[, "Pr(>|t|)"], "BH"),
    row.names = NULL
  )
  
  return(summary_table)
}

testMetadata(cp_faeces, 1, processedFaeces)
testMetadata(cp_faeces, 2, processedFaeces)
testMetadata(cp_milk, 1, processedMilk)
testMetadata(cp_milk, 2, processedMilk)
testMetadata(cp_milkMetab, 1, processedMilkMetab)
testMetadata(cp_milkMetab, 2, processedMilkMetab)
testMetadata(cp_milkMetab, 3, processedMilkMetab)
```
```{r plot models}
colourCols = c("BMI.group", "V3", "")
legendTitles = c("BMI group", "Phylum", "")
xLabels = c("Subject index", "Feature index", "Time index")
legendColNums = c(3,5,0)
arrangeModes = c(TRUE, TRUE, FALSE)
continuousModes = c(FALSE,FALSE,TRUE)

parafac4microbiome::plotPARAFACmodel(cp_faeces$Fac, processedFaeces, 2, colourCols, legendTitles, xLabels, legendColNums, arrangeModes, continuousModes,
  overallTitle = "Infant faecal microbiome")
parafac4microbiome::plotPARAFACmodel(cp_milk$Fac, processedMilk, 2, colourCols, legendTitles, xLabels, legendColNums, arrangeModes, continuousModes,
  overallTitle = "HM microbiome")
parafac4microbiome::plotPARAFACmodel(cp_milkMetab$Fac, processedMilkMetab, 3, colourCols, legendTitles, xLabels, legendColNums, arrangeModes, continuousModes, overallTitle = "HM metabolome")
```
