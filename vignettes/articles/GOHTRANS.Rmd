---
title: "GOHTRANS"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(dplyr)
library(parafac4microbiome)
library(NPLStoolbox)
library(CMTFtoolbox)
```

```{r processing}
processedTongue = processDataCube(NPLStoolbox::Cornejo2025$Tongue_microbiome, sparsityThreshold = 0.5, considerGroups=TRUE, groupVariable="GenderID", CLR=TRUE, centerMode=1, scaleMode=2)
processedSaliva = processDataCube(NPLStoolbox::Cornejo2025$Salivary_microbiome, sparsityThreshold = 0.5, considerGroups=TRUE, groupVariable="GenderID", CLR=TRUE, centerMode=1, scaleMode=2)

processedCytokines = NPLStoolbox::Cornejo2025$Salivary_cytokines
processedCytokines$data = log(processedCytokines$data + 0.1300)
# Remove subject 1, 18, 19, and 27 due to being an outlier
processedCytokines$data = processedCytokines$data[-c(1,9,10,19),,]
processedCytokines$mode1 = processedCytokines$mode1[-c(1,9,10,19),]
processedCytokines$data = multiwayCenter(processedCytokines$data, 1)
processedCytokines$data = multiwayScale(processedCytokines$data, 2)

processedBiochemistry = NPLStoolbox::Cornejo2025$Salivary_biochemistry
processedBiochemistry$data = log(processedBiochemistry$data)
processedBiochemistry$data = multiwayCenter(processedBiochemistry$data, 1)
processedBiochemistry$data = multiwayScale(processedBiochemistry$data, 2)

processedHormones = NPLStoolbox::Cornejo2025$Circulatory_hormones
processedHormones$data = log(processedHormones$data)
processedHormones$data = multiwayCenter(processedHormones$data, 1)
processedHormones$data = multiwayScale(processedHormones$data, 2)
```

```{r cp assess num components}
assessment_tongue = parafac4microbiome::assessModelQuality(processedTongue$data, numRepetitions=10, numCores=10)
assessment_tongue$plots$overview # 1 or 2?

assessment_saliva = parafac4microbiome::assessModelQuality(processedSaliva$data, numRepetitions=10, numCores=10)
assessment_saliva$plots$overview # def 2

assessment_cytokines = parafac4microbiome::assessModelQuality(processedCytokines$data, numRepetitions=10, numCores=10)
assessment_cytokines$plots$overview # def 2

assessment_biochemistry = parafac4microbiome::assessModelQuality(processedBiochemistry$data, numRepetitions=10, numCores=10)
assessment_biochemistry$plots$overview # 2 or 3?

assessment_hormones = parafac4microbiome::assessModelQuality(processedHormones$data, numRepetitions=10, numCores=10)
assessment_hormones$plots$overview # def 2
```

```{r cp stability num components}
colourCols = c("", "", "")
legendTitles = c("", "", "")
xLabels = c("Subject index", "Feature index", "Time index")
legendColNums = c(2,5,0)
arrangeModes = c(FALSE, FALSE, FALSE)
continuousModes = c(FALSE,FALSE,TRUE)

stability_cytokines = parafac4microbiome::assessModelStability(processedBiochemistry, maxNumComponents=4, numFolds=3, colourCols=colourCols, legendTitles=legendTitles, xLabels = xLabels, legendColNums=legendColNums, arrangeModes=arrangeModes, numCores=parallel::detectCores())
stability_cytokines$modelPlots[[2]] # stable at 2
```

```{r make cp models}
cp_tongue = parafac4microbiome::parafac(processedTongue$data, nfac=2, nstart=100)
cp_saliva = parafac4microbiome::parafac(processedSaliva$data, nfac=2, nstart=100)
cp_cytokines = parafac4microbiome::parafac(processedCytokines$data, nfac=2, nstart=100)
cp_biochemistry = parafac4microbiome::parafac(processedBiochemistry$data, nfac=2, nstart=100)
cp_hormones = parafac4microbiome::parafac(processedHormones$data, nfac=1, nstart=100)
```

```{r cp subject metadata test}
testMetadata = function(model, comp, metadata){
  staticMeta = Cornejo2025$Subject_metadata
  
  dynamicMeta = rTensor::k_unfold(rTensor::as.tensor(Cornejo2025$Clinical_measurements$data), 2)@data %>% t() %>% as_tibble()
  colnames(dynamicMeta) = Cornejo2025$Clinical_measurements$mode2$V1
  dynamicMeta = dynamicMeta %>%
    mutate(subject = rep(as.numeric(Cornejo2025$Clinical_measurements$mode1$subject), each=nrow(Cornejo2025$Clinical_measurements$mode3))) %>%
    mutate(newTimepoint = rep(Cornejo2025$Clinical_measurements$mode3$newTimepoint, nrow(Cornejo2025$Clinical_measurements$mode1)))
  
  transformedSubjectLoadings_static = transformPARAFACloadings(model$Fac, 1)[,comp]
  transformedSubjectLoadings_dynamic = transformPARAFACloadings(model$Fac, 2, moreOutput=TRUE)$F[,comp]
  
  metadata_static = metadata$mode1 %>% mutate(subject = as.integer(subject)) %>% left_join(staticMeta) %>% mutate(GenderID = as.numeric(as.factor(GenderID)) - 1)
  metadata_dynamic = transformedSubjectLoadings_dynamic %>% as_tibble() %>% mutate(subject = rep(as.numeric(metadata$mode1$subject), each=nrow(metadata$mode3))) %>% mutate(newTimepoint = rep(metadata$mode3$newTimepoint, nrow(metadata$mode1))) %>% left_join(dynamicMeta)
  
  staticResult = lm(transformedSubjectLoadings_static ~ GenderID + Age, data = metadata_static)
  dynamicResult = lm(transformedSubjectLoadings_dynamic ~ BOP + CODS + XI, data = metadata_dynamic)

  # Extract coefficients and confidence intervals
  coef_estimates <- summary(staticResult)$coefficients
  conf_intervals <- confint(staticResult)
  
  # Remove intercept
  coef_estimates <- coef_estimates[rownames(coef_estimates) != "(Intercept)", ]
  conf_intervals <- conf_intervals[rownames(conf_intervals) != "(Intercept)", ]
  
  # Combine into a clean data frame
  summary_table <- data.frame(
    Term     = rownames(coef_estimates),
    Estimate = round(coef_estimates[, "Estimate"], 2),
    CI       = paste0(
                 round(conf_intervals[, 1], 2), " – ",
                 round(conf_intervals[, 2], 2)
               ),
    P_value  = signif(coef_estimates[, "Pr(>|t|)"], 3),
    row.names = NULL
  )
  
  # Extract coefficients and confidence intervals
  coef_estimates <- summary(dynamicResult)$coefficients
  conf_intervals <- confint(dynamicResult)
  
  # Remove intercept
  coef_estimates <- coef_estimates[rownames(coef_estimates) != "(Intercept)", ]
  conf_intervals <- conf_intervals[rownames(conf_intervals) != "(Intercept)", ]
  
  # Combine into a clean data frame
  summary_table2 <- data.frame(
    Term     = rownames(coef_estimates),
    Estimate = round(coef_estimates[, "Estimate"], 2),
    CI       = paste0(
                 round(conf_intervals[, 1], 2), " – ",
                 round(conf_intervals[, 2], 2)
               ),
    P_value  = signif(coef_estimates[, "Pr(>|t|)"], 3),
    row.names = NULL
  )
  
  result = rbind(summary_table, summary_table2)
  return(result)
}

testMetadata(cp_tongue, 1, processedTongue)
testMetadata(cp_tongue, 2, processedTongue)
testMetadata(cp_saliva, 1, processedSaliva)
testMetadata(cp_saliva, 2, processedSaliva)
testMetadata(cp_cytokines, 1, processedCytokines)
testMetadata(cp_cytokines, 2, processedCytokines)
testMetadata(cp_biochemistry, 1, processedBiochemistry)
testMetadata(cp_biochemistry, 2, processedBiochemistry)
testMetadata(cp_hormones, 1, processedHormones)
```
```{r plot models}
colourCols = c("GenderID", "", "")
legendTitles = c("Gender identity", "", "")
xLabels = c("Subject index", "Feature index", "Time index")
legendColNums = c(2,5,0)
arrangeModes = c(FALSE, FALSE, FALSE)
continuousModes = c(FALSE,FALSE,TRUE)

parafac4microbiome::plotPARAFACmodel(cp_tongue$Fac, processedTongue, 2, colourCols, legendTitles, xLabels, legendColNums, arrangeModes, continuousModes,
  overallTitle = "Tongue microbiome")
parafac4microbiome::plotPARAFACmodel(cp_saliva$Fac, processedSaliva, 2, colourCols, legendTitles, xLabels, legendColNums, arrangeModes, continuousModes,
  overallTitle = "Salivary microbiome")
parafac4microbiome::plotPARAFACmodel(cp_cytokines$Fac, processedCytokines, 2, colourCols, legendTitles, xLabels, legendColNums, arrangeModes, continuousModes, overallTitle = "Salivary cytokines")
parafac4microbiome::plotPARAFACmodel(cp_biochemistry$Fac, processedBiochemistry, 2, colourCols, legendTitles, xLabels, legendColNums, arrangeModes, continuousModes, overallTitle = "Salivary biochemistry")
parafac4microbiome::plotPARAFACmodel(cp_hormones$Fac, processedHormones, 1, colourCols, legendTitles, xLabels, legendColNums, arrangeModes, continuousModes,
  overallTitle = "Circulatory hormones")
```

